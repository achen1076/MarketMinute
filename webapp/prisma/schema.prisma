datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

model User {
  id               String       @id @default(cuid())
  name             String?
  email            String?      @unique
  emailVerified    DateTime?    @map("email_verified")
  image            String?
  password         String?      // Hashed password for email/password auth
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  activeWatchlistId String?     @map("active_watchlist_id")

  // Sentinel preferences
  sentinelFocus    String?      @default("balanced") @map("sentinel_focus") // "tech", "macro", "volatility", "balanced"
  sentinelDepth    String?      @default("standard") @map("sentinel_depth") // "brief", "standard", "detailed"

  // Alert preferences
  alertPreference  String?      @default("on") @map("alert_preference") // "on", "off"

  // Subscription fields
  subscriptionTier   String?    @default("free") @map("subscription_tier") // "free", "basic", "pro", etc.
  stripeCustomerId   String?    @unique @map("stripe_customer_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  subscriptionStatus String?    @default("inactive") @map("subscription_status") // "active", "inactive", "canceled", "past_due"
  subscriptionEndsAt DateTime?  @map("subscription_ends_at")

  // Auth.js relations
  accounts         Account[]
  sessions         Session[]

  // Your app relations (watchlists, etc.)
  activeWatchlist  Watchlist?   @relation("ActiveWatchlist", fields: [activeWatchlistId], references: [id])
  watchlists       Watchlist[]  @relation("UserWatchlists")
  usageLogs        UsageLog[]
  alerts           Alert[]

  @@map("users")
}

model Account {
  id                 String   @id @default(cuid())
  userId             String   @map("user_id")
  type               String
  provider           String
  providerAccountId  String   @map("provider_account_id")
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("email_verification_tokens")
}

model Watchlist {
  id         String          @id @default(cuid())
  userId     String          @map("user_id")
  name       String
  isFavorite Boolean         @default(false) @map("is_favorite")
  createdAt  DateTime        @default(now()) @map("created_at")

  user       User            @relation("UserWatchlists", fields: [userId], references: [id], onDelete: Cascade)
  usersWithAsActive User[]   @relation("ActiveWatchlist")
  items      WatchlistItem[]
  macros     Macro[]
  alerts     Alert[]

  @@map("watchlists")
}

model WatchlistItem {
  id          String     @id @default(cuid())
  watchlistId String     @map("watchlist_id")
  symbol      String
  notes       String?
  order       Int        @default(0)
  isFavorite  Boolean    @default(false) @map("is_favorite")
  createdAt   DateTime   @default(now()) @map("created_at")

  watchlist   Watchlist  @relation(fields: [watchlistId], references: [id], onDelete: Cascade)

  @@map("watchlist_items")
}

model Macro {
  id          String     @id @default(cuid())
  watchlistId String     @map("watchlist_id")
  name        String
  type        String     // "price_change", "volume_spike", "near_52w_high", etc.
  params      String?    @db.Text // JSON string for parameters like threshold values
  enabled     Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at")

  watchlist   Watchlist  @relation(fields: [watchlistId], references: [id], onDelete: Cascade)

  @@map("macros")
}

model UserVisitSnapshot {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  watchlistId String   @map("watchlist_id")
  createdAt   DateTime @default(now()) @map("created_at")
  data        String   @db.Text // JSON: { symbols: [{symbol, price, changePct}], summaryText?, avgChangePct? }

  @@index([userId, watchlistId])
  @@map("user_visit_snapshots")
}

model DailyWatchlistSummary {
  id          String   @id @default(cuid())
  watchlistId String   @map("watchlist_id")
  date        DateTime @db.Date
  avgChangePct Float   @map("avg_change_pct")
  bestPerformer String? @map("best_performer")
  bestChangePct Float?  @map("best_change_pct")
  worstPerformer String? @map("worst_performer")
  worstChangePct Float?  @map("worst_change_pct")
  summaryText String   @map("summary_text")
  fullSummary String?  @db.Text @map("full_summary") // Store complete summary JSON
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([watchlistId, date])
  @@index([watchlistId])
  @@map("daily_watchlist_summaries")
}

model MacroEvent {
  id          String   @id @default(cuid())
  type        String   // "fomc", "cpi", "jobs", "gdp", "other"
  title       String
  date        String   // ISO date string (YYYY-MM-DD)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([type, date])
  @@index([date])
  @@map("macro_events")
}

model TickerEvent {
  id          String   @id @default(cuid())
  symbol      String   // Ticker symbol (e.g., "AAPL")
  type        String   // "earnings", "dividend", "conference", "other"
  title       String
  date        String   // ISO date string (YYYY-MM-DD)
  description String?  @db.Text
  source      String?  // "api" or "news"
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([symbol, type, date])
  @@index([symbol])
  @@index([date])
  @@map("ticker_events")
}

model SentinelReport {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now()) @map("created_at")

  // core report fields
  summary         String   @db.Text
  keyDrivers      Json     @map("key_drivers")
  macroContext    String?  @db.Text @map("macro_context")
  scenarioQuestions Json?  @map("scenario_questions")
  whatThisMeans   Json?    @map("what_this_means") // Structured narrative: whatHappened, whyItMatters, whatCouldHappenNext, whatToWatch

  // anomaly flags
  indexMove       Boolean  @map("index_move")
  sectorRotation  Boolean  @map("sector_rotation")
  macroSurprise   Boolean  @map("macro_surprise")
  volSpike        Boolean  @map("vol_spike")

  // market snapshot summary
  vix             Float?
  vixChangePct    Float?   @map("vix_change_pct")
  realizedVol     Float?   @map("realized_vol")

  // optional: store raw context for later reprocessing
  context         Json

  // optional: user-based reports later on
  userId          String?  @map("user_id")

  @@index([createdAt])
  @@index([indexMove])
  @@index([sectorRotation])
  @@index([macroSurprise])
  @@index([volSpike])
  @@map("sentinel_reports")
}

model InsightReport {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now()) @map("created_at")
  
  // insight cards as JSON array
  cards             Json
  
  // link to the sentinel report this was generated from
  sentinelReportId  String?  @map("sentinel_report_id")
  
  // optional: user-specific insights
  userId            String?  @map("user_id")

  @@index([createdAt])
  @@index([sentinelReportId])
  @@map("insight_reports")
}

model LivePrediction {
  id              String   @id @default(cuid())
  ticker          String
  timestamp       DateTime
  currentPrice    Float    @map("current_price")
  // Raw model outputs (before news adjustment)
  rawSignal       String?  @map("raw_signal")
  rawConfidence   Float?   @map("raw_confidence")
  rawProbUp       Float?   @map("raw_prob_up")
  rawProbNeutral  Float?   @map("raw_prob_neutral")
  rawProbDown     Float?   @map("raw_prob_down")
  // News-adjusted outputs (after Bayesian update)
  signal          String   // "BUY", "SELL", "NEUTRAL"
  confidence      Float
  probUp          Float    @map("prob_up")
  probNeutral     Float    @map("prob_neutral")
  probDown        Float    @map("prob_down")
  newsCount       Int?     @map("news_count")
  shouldTrade     Boolean  @map("should_trade")
  takeProfit      Float?   @map("take_profit")
  stopLoss        Float?   @map("stop_loss")
  atr             Float?
  createdAt       DateTime @default(now()) @map("created_at")
  runId           String   @map("run_id") // Group predictions from same Lambda run

  @@index([ticker])
  @@index([timestamp])
  @@index([runId])
  @@index([createdAt])
  @@map("live_predictions")
}

model DistribionalForecast {
  id                    String   @id @default(cuid())
  ticker                String
  timestamp             DateTime
  currentPrice          Float    @map("current_price")
  expectedRangePct      Float    @map("expected_range_pct")
  upperBound            Float    @map("upper_bound")
  lowerBound            Float    @map("lower_bound")
  directionalBias       String   @map("directional_bias") // "Bullish", "Bearish", "Neutral"
  conviction            String   // "High", "Medium", "Low"
  convictionScore       Float    @map("conviction_score")
  mostLikelyCategory    String   @map("most_likely_category")
  probLargeUp           Float    @map("prob_large_up")
  probMildUp            Float    @map("prob_mild_up")
  probFlat              Float    @map("prob_flat")
  probMildDown          Float    @map("prob_mild_down")
  probLargeDown         Float    @map("prob_large_down")
  p10                   Float
  p50                   Float
  p90                   Float
  createdAt             DateTime @default(now()) @map("created_at")
  runId                 String   @map("run_id") // Group forecasts from same Lambda run

  @@index([ticker])
  @@index([timestamp])
  @@index([runId])
  @@index([createdAt])
  @@map("distributional_forecasts")
}

model NewsItem {
  id        String   @id @default(cuid())
  ticker    String
  headline  String
  sentiment Float
  relevance Float
  category  String?
  summary   String?  @db.Text
  url       String?
  createdAt DateTime @default(now())
}

model ApiCache {
  key       String   @id
  value     Json
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("api_cache")
}

model TickerNewsTraining {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  ticker          String
  headline        String   @db.Text
  newsUrl         String?  @map("news_url") @db.Text
  stockChangePct  Float    @map("stock_change_pct")
  dowChangePct    Float    @map("dow_change_pct")
  spChangePct     Float    @map("sp_change_pct")
  nasdaqChangePct Float    @map("nasdaq_change_pct")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([date, ticker, headline])
  @@index([date])
  @@index([ticker])
  @@index([createdAt])
  @@map("ticker_news_training")
}

model GeneralNewsTraining {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  headline        String   @db.Text
  newsUrl         String?  @map("news_url") @db.Text
  dowChangePct    Float    @map("dow_change_pct")
  spChangePct     Float    @map("sp_change_pct")
  nasdaqChangePct Float    @map("nasdaq_change_pct")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([date, headline])
  @@index([date])
  @@index([createdAt])
  @@map("general_news_training")
}

model UsageLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  feature   String   // "explain", "watchlist", "quant_signal"
  date      DateTime @default(now()) @db.Date
  count     Int      @default(1)
  metadata  Json?    // Store additional context like ticker symbol, etc.
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature, date])
  @@index([userId, date])
  @@index([feature])
  @@map("usage_logs")
}

model Alert {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  watchlistId String?   @map("watchlist_id")
  type        String    // "sentiment_shift", "price_move", "earnings", "52w_high", "52w_low", "test"
  title       String
  message     String    @db.Text
  symbol      String?   // Ticker symbol related to alert
  metadata    Json?     // Additional data (e.g., sentiment values, price changes)
  severity    String    @default("info") // "info", "warning", "critical"
  read        Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist   Watchlist? @relation(fields: [watchlistId], references: [id], onDelete: SetNull)

  @@index([userId, read])
  @@index([watchlistId])
  @@index([createdAt])
  @@map("alerts")
}

model SentimentHistory {
  id        String   @id @default(cuid())
  symbol    String
  date      DateTime @db.Date
  sentiment Float    // Average sentiment score for the day (-1 to 1)
  newsCount Int      @default(0) @map("news_count")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
  @@map("sentiment_history")
}

model TickerAlert {
  id        String   @id @default(cuid())
  symbol    String
  type      String   // "sentiment_shift", "price_move", "earnings", "52w_high", "52w_low", etc.
  title     String
  message   String   @db.Text
  severity  String   @default("info") // "info", "warning", "critical"
  metadata  Json?    // Additional data (e.g., sentiment values, price changes)
  expiresAt DateTime? @map("expires_at") // Optional expiration for time-sensitive alerts
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([symbol, type, createdAt]) // Prevent duplicate alerts for same symbol/type at same time
  @@index([symbol])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("ticker_alerts")
}