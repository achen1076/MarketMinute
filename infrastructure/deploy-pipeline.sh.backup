#!/bin/bash
set -e

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MarketMinute Infrastructure Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Complete end-to-end deployment pipeline for AWS infrastructure
# Handles: Prerequisites â†’ Docker Builds â†’ Terraform â†’ Validation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Emoji helpers
say_ok()    { echo -e "${GREEN}âœ… $1${NC}"; }
say_err()   { echo -e "${RED}âŒ $1${NC}"; }
say_warn()  { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
say_info()  { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
say_step()  { echo -e "${CYAN}ğŸ”¹ $1${NC}"; }
say_header(){ echo -e "${PURPLE}$1${NC}"; }

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
TERRAFORM_DIR="${SCRIPT_DIR}/terraform"
QUANT_DIR="${PROJECT_ROOT}/quant"
AWS_REGION="us-east-1"

# Parse arguments
SKIP_DOCKER=false
SKIP_SAGEMAKER=false
SKIP_LAMBDA=false
SKIP_PLAN=false
AUTO_APPROVE=false
DESTROY=false

show_help() {
  cat << EOF
MarketMinute Infrastructure Pipeline

USAGE:
  ./deploy-pipeline.sh [OPTIONS]

OPTIONS:
  --skip-docker        Skip all Docker builds (SageMaker + Lambda)
  --skip-sagemaker     Skip SageMaker Docker build only
  --skip-lambda        Skip Lambda Docker build only
  --skip-plan          Skip terraform plan (not recommended)
  --auto-approve       Auto-approve terraform apply (use with caution)
  --destroy            Run terraform destroy instead of apply
  --help               Show this help message

EXAMPLES:
  # Full deployment with interactive approval
  ./deploy-pipeline.sh

  # Quick config-only update (skip Docker builds)
  ./deploy-pipeline.sh --skip-docker

  # Full automated deployment
  ./deploy-pipeline.sh --auto-approve

  # Tear down infrastructure
  ./deploy-pipeline.sh --destroy

WORKFLOW:
  1. âœ“ Check prerequisites (AWS CLI, Terraform, Docker)
  2. âœ“ Validate AWS credentials
  3. âœ“ Build & push SageMaker container to ECR
  4. âœ“ Build & push Lambda container to ECR
  5. âœ“ Initialize Terraform
  6. âœ“ Plan infrastructure changes
  7. âœ“ Apply changes (with approval)
  8. âœ“ Display outputs and test commands

EOF
}

while [[ $# -gt 0 ]]; do
  case $1 in
    --skip-docker)     SKIP_DOCKER=true; shift ;;
    --skip-sagemaker)  SKIP_SAGEMAKER=true; shift ;;
    --skip-lambda)     SKIP_LAMBDA=true; shift ;;
    --skip-plan)       SKIP_PLAN=true; shift ;;
    --auto-approve)    AUTO_APPROVE=true; shift ;;
    --destroy)         DESTROY=true; shift ;;
    --help)            show_help; exit 0 ;;
    *)                 say_err "Unknown option: $1"; show_help; exit 1 ;;
  esac
done

# Header
clear
echo
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
say_header "   ğŸš€ MarketMinute Infrastructure Pipeline"
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo
say_info "Project Root: ${PROJECT_ROOT}"
say_info "Terraform:    ${TERRAFORM_DIR}"
say_info "Region:       ${AWS_REGION}"
echo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1: Prerequisites Check
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
say_header "PHASE 1: Prerequisites Check"
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo

say_step "Checking AWS CLI..."
if ! command -v aws >/dev/null 2>&1; then
  say_err "AWS CLI not found. Install: brew install awscli"
  exit 1
fi
say_ok "AWS CLI installed ($(aws --version | cut -d' ' -f1))"

say_step "Checking Terraform..."
if ! command -v terraform >/dev/null 2>&1; then
  say_err "Terraform not found. Install: brew install hashicorp/tap/terraform"
  exit 1
fi
say_ok "Terraform installed ($(terraform version | head -n1))"

if [ "$SKIP_DOCKER" = false ]; then
  say_step "Checking Docker..."
  if ! command -v docker >/dev/null 2>&1; then
    say_err "Docker not found. Install: https://www.docker.com/products/docker-desktop"
    exit 1
  fi
  if ! docker info >/dev/null 2>&1; then
    say_err "Docker daemon not running. Start Docker Desktop."
    exit 1
  fi
  say_ok "Docker running ($(docker --version | cut -d' ' -f3 | tr -d ','))"
fi

say_step "Validating AWS credentials..."
if ! aws sts get-caller-identity >/dev/null 2>&1; then
  say_err "AWS credentials not configured. Run: aws configure"
  exit 1
fi
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
AWS_USER=$(aws sts get-caller-identity --query Arn --output text | cut -d'/' -f2)
say_ok "Authenticated as: ${AWS_USER}"
say_ok "Account ID: ${ACCOUNT_ID}"

say_step "Checking terraform.tfvars..."
cd "${TERRAFORM_DIR}"
if [ ! -f "terraform.tfvars" ]; then
  say_err "terraform.tfvars not found!"
  if [ -f "terraform.tfvars.example" ]; then
    say_warn "Creating from terraform.tfvars.example..."
    cp terraform.tfvars.example terraform.tfvars
    say_warn "Please edit terraform.tfvars before proceeding."
    exit 1
  else
    say_err "No terraform.tfvars or example found."
    exit 1
  fi
fi
say_ok "terraform.tfvars exists"

echo
say_ok "All prerequisites satisfied!"
echo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2: Docker Image Builds
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$SKIP_DOCKER" = false ]; then
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  say_header "PHASE 2: Docker Image Builds"
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2A: SageMaker Container
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if [ "$SKIP_SAGEMAKER" = false ]; then
    say_step "Building SageMaker container..."
    echo
    
    SAGEMAKER_REPO="marketminute-sagemaker"
    SAGEMAKER_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${SAGEMAKER_REPO}:latest"
    
    cd "${QUANT_DIR}/sagemaker"
    
    # Ensure ECR repo
    say_info "Checking ECR repository: ${SAGEMAKER_REPO}"
    if ! aws ecr describe-repositories --repository-names "${SAGEMAKER_REPO}" --region "${AWS_REGION}" >/dev/null 2>&1; then
      say_warn "Creating ECR repository..."
      aws ecr create-repository \
        --repository-name "${SAGEMAKER_REPO}" \
        --image-scanning-configuration scanOnPush=true \
        --region "${AWS_REGION}" >/dev/null
      say_ok "Repository created"
    else
      say_ok "Repository exists"
    fi
    
    # ECR login
    say_info "Logging into ECR..."
    aws ecr get-login-password --region "${AWS_REGION}" \
      | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" >/dev/null 2>&1
    say_ok "ECR login successful"
    
    # Prepare build context
    say_info "Preparing build context..."
    rm -rf models src
    cp -r ../models/lgbm models
    cp -r ../src src
    say_ok "Copied models and src"
    
    # Build
    say_info "Building Docker image (this may take a few minutes)..."
    docker build \
      --platform linux/amd64 \
      --provenance=false \
      -t "${SAGEMAKER_REPO}:latest" \
      . >/dev/null
    say_ok "Image built"
    
    # Tag & Push
    say_info "Pushing to ECR..."
    docker tag "${SAGEMAKER_REPO}:latest" "${SAGEMAKER_URI}"
    docker push "${SAGEMAKER_URI}" >/dev/null
    say_ok "Pushed: ${SAGEMAKER_URI}"
    
    # Cleanup
    rm -rf models src
    
    echo
    say_ok "SageMaker container ready!"
    echo
  else
    say_warn "Skipping SageMaker build (--skip-sagemaker)"
    echo
  fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2B: Lambda Container
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if [ "$SKIP_LAMBDA" = false ]; then
    say_step "Building Lambda container..."
    echo
    
    LAMBDA_REPO="marketminute-lambda"
    LAMBDA_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${LAMBDA_REPO}:latest"
    
    cd "${QUANT_DIR}/lambda"
    
    # Ensure ECR repo
    say_info "Checking ECR repository: ${LAMBDA_REPO}"
    if ! aws ecr describe-repositories --repository-names "${LAMBDA_REPO}" --region "${AWS_REGION}" >/dev/null 2>&1; then
      say_warn "Creating ECR repository..."
      aws ecr create-repository \
        --repository-name "${LAMBDA_REPO}" \
        --image-scanning-configuration scanOnPush=true \
        --region "${AWS_REGION}" >/dev/null
      say_ok "Repository created"
    else
      say_ok "Repository exists"
    fi
    
    # ECR login
    say_info "Logging into ECR..."
    aws ecr get-login-password --region "${AWS_REGION}" \
      | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" >/dev/null 2>&1
    say_ok "ECR login successful"
    
    # Build
    say_info "Building Docker image..."
    docker build \
      --platform linux/amd64 \
      -t "${LAMBDA_REPO}:latest" \
      . >/dev/null
    say_ok "Image built"
    
    # Tag & Push
    say_info "Pushing to ECR..."
    docker tag "${LAMBDA_REPO}:latest" "${LAMBDA_URI}"
    docker push "${LAMBDA_URI}" >/dev/null
    say_ok "Pushed: ${LAMBDA_URI}"
    
    echo
    say_ok "Lambda container ready!"
    echo
  else
    say_warn "Skipping Lambda build (--skip-lambda)"
    echo
  fi
  
  say_ok "All Docker images built and pushed!"
  echo
else
  say_warn "Skipping all Docker builds (--skip-docker)"
  echo
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3: Terraform Initialization
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
say_header "PHASE 3: Terraform Initialization"
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo

cd "${TERRAFORM_DIR}"

say_step "Running terraform init..."
terraform init -reconfigure >/dev/null
say_ok "Terraform initialized"
echo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4: Terraform Plan
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$DESTROY" = false ] && [ "$SKIP_PLAN" = false ]; then
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  say_header "PHASE 4: Terraform Plan"
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo

  say_step "Generating execution plan..."
  if terraform plan -out=tfplan; then
    say_ok "Plan generated successfully"
  else
    say_err "Plan failed! Review the errors above."
    exit 1
  fi
  echo
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 5: Terraform Apply/Destroy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ "$DESTROY" = true ]; then
  say_header "PHASE 5: Terraform Destroy"
else
  say_header "PHASE 5: Terraform Apply"
fi
say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo

if [ "$DESTROY" = true ]; then
  say_warn "âš ï¸  WARNING: This will DESTROY all infrastructure!"
  say_warn "Resources to be deleted:"
  say_warn "  â€¢ SageMaker endpoint (may take 5-10 minutes)"
  say_warn "  â€¢ Lambda function"
  say_warn "  â€¢ EventBridge rules"
  say_warn "  â€¢ IAM roles and policies"
  echo
  
  if [ "$AUTO_APPROVE" = false ]; then
    read -p "Type 'destroy' to confirm: " CONFIRM
    if [ "$CONFIRM" != "destroy" ]; then
      say_warn "Destroy cancelled."
      exit 0
    fi
  fi
  
  say_step "Destroying infrastructure..."
  if terraform destroy -auto-approve; then
    say_ok "Infrastructure destroyed"
  else
    say_err "Destroy failed!"
    exit 1
  fi
else
  if [ "$AUTO_APPROVE" = false ] && [ "$SKIP_PLAN" = false ]; then
    say_warn "Review the plan above."
    read -p "Type 'yes' to apply: " CONFIRM
    if [ "$CONFIRM" != "yes" ]; then
      say_warn "Apply cancelled."
      rm -f tfplan
      exit 0
    fi
  fi
  
  say_step "Applying infrastructure changes..."
  if [ "$SKIP_PLAN" = false ]; then
    terraform apply tfplan
  else
    if [ "$AUTO_APPROVE" = true ]; then
      terraform apply -auto-approve
    else
      terraform apply
    fi
  fi
  say_ok "Infrastructure deployed!"
  rm -f tfplan
fi

echo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 6: Deployment Summary
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$DESTROY" = false ]; then
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  say_header "PHASE 6: Deployment Summary"
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo

  say_step "Terraform Outputs:"
  terraform output
  echo

  # Get specific outputs for testing commands
  LAMBDA_URL=$(terraform output -raw lambda_function_url 2>/dev/null || echo "")
  SAGEMAKER_ENDPOINT=$(terraform output -raw sagemaker_endpoint_name 2>/dev/null || echo "")
  EVENTBRIDGE_SCHEDULE=$(terraform output -raw eventbridge_schedule 2>/dev/null || echo "")
  
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  say_ok "ğŸ‰ Deployment Complete!"
  say_header "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo
  
  echo -e "${CYAN}ğŸ“Š Deployed Resources:${NC}"
  echo "  â€¢ Lambda Function URL: ${LAMBDA_URL}"
  echo "  â€¢ SageMaker Endpoint:  ${SAGEMAKER_ENDPOINT}"
  echo "  â€¢ Cron Schedule:       ${EVENTBRIDGE_SCHEDULE}"
  echo
  
  echo -e "${CYAN}ğŸ§ª Test Your Deployment:${NC}"
  echo
  echo "  # Test Lambda Function URL"
  echo "  curl -X POST '${LAMBDA_URL}' \\"
  echo "    -H 'Content-Type: application/json' \\"
  echo "    -d '{\"task\":\"daily_analysis\"}'"
  echo
  
  echo -e "${CYAN}ğŸ“ Monitor Logs:${NC}"
  echo
  echo "  # Lambda logs"
  echo "  aws logs tail /aws/lambda/marketminute-dev-orchestrator --follow"
  echo
  echo "  # SageMaker logs"
  echo "  aws logs tail /aws/sagemaker/Endpoints/${SAGEMAKER_ENDPOINT} --follow"
  echo
  
  echo -e "${CYAN}ğŸ”§ Next Steps:${NC}"
  echo "  1. Test the Lambda endpoint (command above)"
  echo "  2. Upload Schwab token: ./scripts/upload_schwab_token.sh"
  echo "  3. Check your webapp admin panel for manual triggers"
  echo "  4. Monitor the scheduled cron job execution"
  echo
  
  say_ok "âœ¨ Your infrastructure is live and ready!"
  echo
fi

cd "${PROJECT_ROOT}"
